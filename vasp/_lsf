#!/bin/bash -l

# ./$APPNAME/_slurm $APPNAME $CLUSTER $QUEUENAME $TOTAL_CORES $JOBTYPE $STARTDIR $TESTDIR $TASKSPERNODE
APPNAME=$1
CLUSTER=$2
QUEUENAME=$3
TOTAL_CORES=$4
JOBTYPE=$5
STARTDIR=$6
TESTDIR=$7
TASKSPERNODE=$8


# Create JOBDIR
TIMESTAMP=`date +%s`
JOBDIR=$TESTDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP
mkdir -p $JOBDIR
RESULTS_DIR=$STARTDIR/_results/$APPNAME/$CLUSTER/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP

# Copy Job Data
DATADIR=$STARTDIR/$APPNAME/$JOBTYPE
cp -a $DATADIR/* $JOBDIR/

# Change directory
cd $JOBDIR

SUBMITFILE="$APPNAME.bsub"
DEPFILE="$APPNAME.dependency.bsub"

cat > $SUBMITFILE << EOF
#!/bin/bash -l
 
#BSUB -J $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#BSUB -o $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out
#BSUB -e $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err
#BSUB -q $QUEUENAME
#BSUB -n $TOTAL_CORES
#BSUB -R "span[ptile=$TASKSPERNODE]"

cd $JOBDIR
## VASP Specific
module purge
module load vasp

time mpirun vasp

EOF

SUBMITSTRING=$(bsub < $SUBMITFILE)
JOBID=`echo $SUBMITSTRING| awk '{print $2}' | grep  -o '[0-9]\+'`
echo "Submitting JOB from $JOBDIR with JOBID ${JOBID}"

cat > $DEPFILE << EOF
#!/bin/bash -l
 
#BSUB -w "done(${JOBID})"
#BSUB -J Copy_back_$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#BSUB -q $QUEUENAME
#BSUB -n 1

mkdir -p $RESULTS_DIR

cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out" "$RESULTS_DIR"
cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err" "$RESULTS_DIR"
cp "$JOBDIR/OUTCAR" "$RESULTS_DIR"
#rm -rf "$JOBDIR"
EOF

DEPENDENCYSTRING=$(bsub < $DEPFILE)
DEPJOBID=`echo $DEPENDENCYSTRING| awk '{print $2}' | grep  -o '[0-9]\+'`
echo "Submitting Dependency JOB from $JOBDIR with JOBID ${DEPJOBID}"
echo
echo "Results directory is $RESULTS_DIR"
