#!/bin/bash -l

# ./$APPNAME/_slurm $APPNAME $CLUSTER $QUEUENAME $TOTAL_CORES $JOBTYPE $STARTDIR $TESTDIR $TASKSPERNODE
APPNAME=$1
CLUSTER=$2
QUEUENAME=$3
TOTAL_CORES=$4
JOBTYPE=$5
STARTDIR=$6
TESTDIR=$7
TASKSPERNODE=$8


# Create JOBDIR
TIMESTAMP=`date +%s`
JOBDIR=$TESTDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP
mkdir -p $JOBDIR
RESULTS_DIR=$STARTDIR/_results/$APPNAME/$CLUSTER/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP

# Copy Job Data
DATADIR=$STARTDIR/$APPNAME/$JOBTYPE
cp -a $DATADIR/* $JOBDIR/

# Change directory
cd $JOBDIR

SUBMITFILE="$APPNAME.sbatch"
DEPFILE="$APPNAME.dependency.sbatch"

cat > $SUBMITFILE << EOF
#!/bin/bash -l
 
#SBATCH -J $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#SBATCH -o $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out
#SBATCH -e $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err
#SBATCH -p $QUEUENAME
#SBATCH --ntasks=$TOTAL_CORES
#SBATCH --exclusive

cd $JOBDIR
## VASP Specific
module purge
module load vasp

echo '$SLURM_JOB_NODELIST' > hosts.mpd

time mpirun -f hosts.mpd -np $TOTAL_CORES -ppn $TASKSPERNODE -env I_MPI_FABRICS=dapl -env I_MPI_DAPL_PROVIDER=ofa-v2-ib0 -env I_MPI_DYNAMIC_CONNECTION=0 -genv I_MPI_DEBUG 100 vasp
EOF

SUBMITSTRING=$(sbatch $SUBMITFILE)
echo "Submitting JOB from $JOBDIR with JOBID ${SUBMITSTRING##* }"

cat > $DEPFILE << EOF
#!/bin/bash -l
 
#SBATCH --dependency=afterany:${SUBMITSTRING##* }
#SBATCH -J Copy_back_$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#SBATCH -p $QUEUENAME
#SBATCH -n 1

mkdir -p $RESULTS_DIR

cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out" "$RESULTS_DIR"
cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err" "$RESULTS_DIR"
cp "$JOBDIR/OUTCAR" "$RESULTS_DIR"
rm -rf "$JOBDIR"
EOF

DEPENDENCYSTRING=$(sbatch $DEPFILE)
echo "Submitting Dependency JOB from $JOBDIR with JOBID ${DEPENDENCYSTRING##* }"
echo
echo "Results directory is $RESULTS_DIR"