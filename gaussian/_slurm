#!/bin/bash -l

# ./$APPNAME/_slurm $APPNAME $CLUSTER $QUEUENAME $TOTAL_CORES $JOBTYPE $STARTDIR $TESTDIR $TASKSPERNODE
APPNAME=$1
CLUSTER=$2
QUEUENAME=$3
TOTAL_CORES=$4
JOBTYPE=$5
STARTDIR=$6
TESTDIR=$7
TASKSPERNODE=$8


# Create JOBDIR
TIMESTAMP=`date +%s`
JOBDIR=$TESTDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP
mkdir -p $JOBDIR
RESULTS_DIR=$STARTDIR/_results/$APPNAME/$CLUSTER/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP

# Copy Job Data
DATADIR=$STARTDIR/$APPNAME/$JOBTYPE
cp -a $DATADIR/* $JOBDIR/

# Change directory
cd $JOBDIR

SUBMITFILE="$APPNAME.sbatch"
DEPFILE="$APPNAME.dependency.sbatch"

cat > $SUBMITFILE << EOF
#!/bin/bash -l

#SBATCH -J $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#SBATCH -o $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out
#SBATCH -e $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err
#SBATCH -p $QUEUENAME
#SBATCH --ntasks=$TOTAL_CORES
#SBATCH --exclusive

cd $JOBDIR
## GAUSSIAN Specific
module purge
module load gaussian

export GAUSS_SCRDIR=$JOBDIR
export OMP_NUM_THREADS=${TOTAL_CORES}
time ( echo %NProcShared=${TOTAL_CORES}; cat $JOBTYPE.dat ) | g09 > $JOBTYPE.out

EOF

SUBMITSTRING=$(sbatch $SUBMITFILE)
echo "Submitting JOB from $JOBDIR with JOBID ${SUBMITSTRING##* }"

cat > $DEPFILE << EOF
#!/bin/bash -l

#SBATCH --dependency=afterany:${SUBMITSTRING##* }
#SBATCH -J Copy_back_$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#SBATCH -p $QUEUENAME
#SBATCH -n 1

mkdir -p $RESULTS_DIR

cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out" "$RESULTS_DIR"
cp "$JOBDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err" "$RESULTS_DIR"
cp "$JOBDIR/$JOBTYPE.out" "$RESULTS_DIR"
cp "$JOBDIR/*.chk" "$RESULTS_DIR"
rm -rf "$JOBDIR"
EOF

DEPENDENCYSTRING=$(sbatch $DEPFILE)
echo "Submitting Dependency JOB from $JOBDIR with JOBID ${DEPENDENCYSTRING##* }"
echo
echo "Results directory is $RESULTS_DIR"
