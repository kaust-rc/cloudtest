#!/bin/bash -l

# ./$APPNAME/_lsf $APPNAME $CLUSTER $QUEUENAME $TOTAL_CORES $JOBTYPE $STARTDIR $TESTDIR $TASKSPERNODE
APPNAME=$1
CLUSTER=$2
QUEUENAME=$3
TOTAL_CORES=$4
JOBTYPE=$5
STARTDIR=$6
TESTDIR=$7
TASKSPERNODE=$8


# Create JOBDIR
TIMESTAMP=`date +%s`
JOBDIR=$TESTDIR/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP
mkdir -p $JOBDIR
RESULTS_DIR=$STARTDIR/_results/$APPNAME/$CLUSTER/$APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES-$TIMESTAMP

# Copy Job Data
DATADIR=$STARTDIR/$APPNAME/$JOBTYPE
cp -a $DATADIR/* $JOBDIR/

# Change directory
cd $JOBDIR

SUBMITFILE="$APPNAME.bsub"
DEPFILE="$APPNAME.dependency.bsub"

cat > $SUBMITFILE << EOF
#!/bin/bash -l

#BSUB -J $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES
#BSUB -o $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.out
#BSUB -e $APPNAME-$CLUSTER-$JOBTYPE-$TOTAL_CORES.err
#BSUB -q $QUEUENAME
#BSUB -n $TOTAL_CORES


cd $JOBDIR
## GAUSSIAN Specific
module purge
module load gaussian

export GAUSS_SCRDIR=$JOBDIR
export OMP_NUM_THREADS=1
time ( echo %NProcShared=${TOTAL_CORES}; cat $JOBTYPE.dat ) | g09 > $JOBTYPE.out

EOF

bsub < $SUBMITFILE
